// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Supplier {
  id            String         @id @default(cuid())
  name          String
  address       String
  phone         String
  email         String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  gstNo         String
  DLno          String
  products      Product[]
  purchaseBills PurchaseBill[]
}

model Product {
  id String @id @default(cuid())

  name       String
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  status   ProductStatus @default(CONTINUE)
  type     ProductType   @default(NORMAL)
  itemType ItemType      @default(NORMAL)

  packing       String?
  unitPrimary   String
  unitSecondary String?
  askDose       String?
  decimal       Float   @default(0)

  colorType String?
  company   String?
  salt      String?
  category  String?

  localName   String?
  centralName String?

  sgst Float @default(0)
  cgst Float @default(0)
  igst Float @default(0)

  mrp Float @default(0)
  // purchaseRate Float @default(0)

  rateA Float @default(0)
  rateB Float @default(0)
  rateC Float @default(0)
  Prate Float @default(0)

  cost     Float @default(0)
  ConvCASE Float @default(1)
  ConvCAS  Float @default(1)

  hsnSac     String?
  gstPercent Float   @default(0)

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  purchaseBillItems PurchaseBillItem[]
  stocks            Stock[]
  saleBillItems     SaleBillItem[]

  // ðŸ”¥ IMPORTANT
  @@unique([name, supplierId])
}

enum ProductStatus {
  CONTINUE
  DISCONTINUE
}

enum ProductType {
  NORMAL
  SERVICE
  DISCONTINUE
}

enum ItemType {
  NORMAL
  CONTROLLED
  SCHEDULED
}

model PurchaseBill {
  id          String   @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime

  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  // ---- Aggregated amounts ----
  totalAmount   Decimal  @db.Decimal(12, 2)
  discount      Decimal  @default(0) @db.Decimal(12, 2)
  taxableAmount Decimal  @default(0) @db.Decimal(12, 2)

  totalGST    Decimal @db.Decimal(12, 2)
  cgstPayable Decimal @default(0) @db.Decimal(12, 2)
  sgstPayable Decimal @default(0) @db.Decimal(12, 2)

  roundOff  Decimal @db.Decimal(12, 2)
  netAmount Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  items PurchaseBillItem[]

  @@unique([invoiceNo, supplierId])
}

model PurchaseBillItem {
  id String @id @default(cuid())

  billId String
  bill   PurchaseBill @relation(fields: [billId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  batchNo    String
  expiryDate DateTime

  quantity Int
  freeQty  Int @default(0)

  purchaseRate Decimal @db.Decimal(12, 2)
  mrp          Decimal @db.Decimal(12, 2)
  gstPercent   Int

  taxableAmount Float
  gstAmount     Decimal @db.Decimal(12, 2)
  totalAmount   Decimal @db.Decimal(12, 2)
}

model Stock {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  batchNo    String
  expiryDate DateTime

  quantity     Int
  purchaseRate Float
  mrp          Float

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  saleBillItems SaleBillItem[]

  @@unique([productId, batchNo])
}

model template {
  id          String   @id @default(cuid())
  name        String
  description Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SaleBill {
  id            String         @id @default(cuid())
  Customer_Name String
  createdAt     DateTime       @default(now())
  phone         String
  amount        Decimal        @db.Decimal(12, 2)
  discount      Decimal        @db.Decimal(12, 2)
  TotalAmount   Decimal        @db.Decimal(12, 2)
  items         SaleBillItem[]
}

model SaleBillItem {
  id String @id @default(cuid())

  billId    String
  productId String
  stockId   String?

  quantity   Int
  itemAmount Decimal @db.Decimal(12, 2)
  mrp        Decimal @db.Decimal(12, 2)

  bill    SaleBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  stock   Stock?    @relation(fields: [stockId], references: [id])
  product Product  @relation(fields: [productId], references: [id])

  @@index([billId])
  @@index([stockId])
}
